<link rel="stylesheet" href="/css/auth.css">

<section class="auth-section">

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="466885260272-86cp1p5tkpsspvrdp8n79h0gbfob48qq.apps.googleusercontent.com"
       data-context="signin"
       data-auto_select="true"
       data-itp_support="true">
  </div>

  <div class="g_id_signin" data-type="standard"></div>

  <p>or</p>

  <h2>Login to CampusNotes</h2>
  
  <form id="loginForm" action="/login" method="POST">
    <input type="email" id="emailInput" name="email" placeholder="Email" required />
    <input type="password" name="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <p class="muted">
    <a href="/forgot">Forgot your password?</a>
  </p>

  <p class="muted">
    Not a member yet? <a href="/register-n">Register here</a>
  </p>
</section>

<!-- Google Script -->
<script src="https://accounts.google.com/gsi/client" async></script>

<script>
  function decodeJWT(token) {
    let base64Url = token.split(".")[1];
    let base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
    let jsonPayload = decodeURIComponent(
      atob(base64)
        .split("")
        .map(c => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
        .join("")
    );
    return JSON.parse(jsonPayload);
  }

  function handleCredentialResponse(response) {
    const body = { credential: response.credential };

    fetch("/oauth2callback", {
      method: "POST",
      body: JSON.stringify(body),
      headers: { "Content-Type": "application/json" }
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = `/profile/${data.userId}`;
        }
      });
  }

  window.onload = function () {
    google.accounts.id.initialize({
      client_id: "466885260272-86cp1p5tkpsspvrdp8n79h0gbfob48qq.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.querySelector(".g_id_signin"),
      { theme: "outline", size: "large" }
    );
  };

  document.getElementById("loginForm").addEventListener("submit", e => {
    let emailField = document.getElementById("emailInput");
    emailField.value = emailField.value.toLowerCase().trim();
  });
</script>
