<link rel="stylesheet" href="/css/auth.css">

<section class="auth-section">

  <h2>Forgot Password</h2>
  <p class="sub">Enter your registered email — we’ll send an OTP.</p>

  <% if (typeof flash !== "undefined" && flash && flash.message) { %>
    <div class="alert <%= flash.type === 'success' ? 'success' : 'error' %>">
      <%= flash.message %>
    </div>
  <% } %>

  <% if (step === "otp") { %>

    <!-- Step 2: OTP + reset new password -->
    <div class="readonly-chip">
      <span><strong>Email:</strong> <%= email %></span>
      <a href="/forgot">Change</a>
    </div>

    <form action="/forgot/verify" method="POST">
      <% if (typeof csrfToken !== "undefined") { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>

      <input type="hidden" name="email" value="<%= email %>">

      <input type="text" name="otp" placeholder="Enter 6-digit OTP" maxlength="6" required />

      <input type="password" name="password" placeholder="New password" required />
      <input type="password" name="confirmPassword" placeholder="Confirm new password" required />

      <button type="submit">Reset Password</button>
    </form>

    <form action="/forgot/resend" method="POST" class="row" style="margin-top:10px;">
      <% if (typeof csrfToken !== "undefined") { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>
      <input type="hidden" name="email" value="<%= email %>">
      <button class="btn-secondary flex-1" type="submit" id="resendBtn">Resend OTP</button>
    </form>

    <p class="muted">Didn’t get OTP? Request again.</p>

  <% } else { %>

    <!-- Step 1: Email -->
    <form action="/forgot/send-otp" method="POST">
      <% if (typeof csrfToken !== "undefined") { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>

      <input 
        type="email" 
        name="email" 
        placeholder="Registered Email" 
        value="<%= typeof email !== 'undefined' ? email : '' %>" 
        required 
      />
      <button type="submit">Send OTP</button>
    </form>

    <p class="muted"><a href="/login-n">Back to Login</a></p>

  <% } %>
</section>

<script>
  // OTP resend UX cooldown
  const btn = document.getElementById("resendBtn");
  if (btn) {
    let original = btn.textContent;
    btn.addEventListener("click", () => {
      let s = 30;
      btn.disabled = true;
      btn.textContent = `Resend in ${s}s`;
      let t = setInterval(() => {
        s--;
        if (s <= 0) {
          clearInterval(t);
          btn.disabled = false;
          btn.textContent = original;
        } else {
          btn.textContent = `Resend in ${s}s`;
        }
      }, 1000);
    });
  }

  // Password validations
  const verifyForm = document.querySelector('form[action="/forgot/verify"]');
  if (verifyForm) {
    verifyForm.addEventListener("submit", e => {
      const pwd = verifyForm.password.value;
      const confirm = verifyForm.confirmPassword.value;

      if (pwd.length < 8) {
        alert("Password must be at least 8 characters.");
        e.preventDefault();
        return;
      }

      if (pwd !== confirm) {
        alert("Passwords do not match.");
        e.preventDefault();
      }
    });
  }
</script>
