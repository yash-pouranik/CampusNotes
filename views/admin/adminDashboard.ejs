<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>

<style>
  :root {
    --primary: #4f46e5; --primary-light: #e0e7ff; --bg: #f3f4f6;
    --card-bg: #ffffff; --text-dark: #111827; --text-light: #6b7280;
    --border: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
    --radius: 12px; --transition: all 0.25s ease-in-out;
  }
  .dashboard-body { background-color: var(--bg); color: var(--text-dark); font-family: "Inter", Arial, sans-serif; }
  .dashboard-container { padding: 1.5rem; max-width: 1600px; margin: auto; }
  .dashboard-header { margin-bottom: 1.5rem; }
  .dashboard-header h1 { font-size: 1.8rem; font-weight: 700; }
  .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-dark); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
  .stat-card { background: var(--card-bg); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); transition: var(--transition); }
  .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
  .stat-card .header { display: flex; justify-content: space-between; align-items: center; color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.75rem; }
  .stat-card .value { font-size: 2.25rem; font-weight: 700; }
  .stat-card .footer { font-size: 0.8rem; color: var(--text-light); margin-top: 1rem; }
  .green { color: #10b981; } .red { color: #ef4444; }
  .dashboard-main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
  .table-card, .sidebar-card { background: var(--card-bg); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
  .card-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; }
  
  /* === FIX FOR RESPONSIVE TABLES === */
  .table-wrapper {
    overflow-x: auto;
  }
  
  .dashboard-table { width: 100%; border-collapse: collapse; }
  .dashboard-table th, .dashboard-table td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 0.9rem; white-space: nowrap; }
  .dashboard-table th { font-weight: 600; color: var(--text-light); }
  .dashboard-table td { color: #334155; }
  .dashboard-table tr:last-child td { border-bottom: none; }
  .dashboard-table tr:hover { background-color: #f8f9fa; }
  .chart-container { height: 250px; display: flex; justify-content: center; align-items: center; }
  .contributor-list .contributor { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
  .contributor-list img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .contributor-list .name { font-weight: 600; }
  .contributor-list .uploads { color: var(--text-light); font-size: 0.85rem; }
  @media (max-width: 1024px) { .dashboard-main-grid { grid-template-columns: 1fr; } }
</style>

<div class="dashboard-body">
  <div class="dashboard-container">
    <header class="dashboard-header"><h1>Admin Dashboard</h1></header>
    
    <h2 class="section-title">Core Metrics</h2>
    <section class="stats-grid">
      <div class="stat-card">
        <div class="header"><span>Total Users</span><i class="fas fa-users"></i></div>
        <p class="value"><%= totalUsers %></p>
        <p class="footer"><span class="green">+<%= newSignups %></span> in last 7 days</p>
      </div>
      <div class="stat-card">
        <div class="header"><span>Total Notes</span><i class="fas fa-file-alt"></i></div>
        <p class="value"><%= totalNotes %></p>
        <p class="footer"><span class="green">+<%= newNoteUploads %></span> in last 7 days</p>
      </div>
      <div class="stat-card">
        <div class="header"><span>Total Downloads</span><i class="fas fa-download"></i></div>
        <p class="value"><%= totalDownloads %></p>
        <p class="footer"><span class="green">+<%= downloadsLast7Days %></span> in last 7 days</p>
      </div>
      <div class="stat-card">
        <div class="header"><span>Pending Notes</span><i class="fas fa-tasks"></i></div>
        <p class="value red"><%= notesPendingVerification %></p>
        <p class="footer">Awaiting review</p>
      </div>
    </section>

    <h2 class="section-title">Traffic Analysis</h2>
    <section class="stats-grid">
        <div class="stat-card">
            <div class="header"><span>Unique Downloads</span><i class="fas fa-user-check"></i></div>
            <p class="value"><%= totalUniqueDownloads %><span style="font-size: 1rem;">(out of <%= totalDownloads - 558 %>)</span></p>
        </div>
        <div class="stat-card">
            <div class="header"><span>Unique Sessions</span><i class="fas fa-street-view"></i></div>
            <p class="value"><%= uniqueSessions %></p>
        </div>
        <div class="stat-card">
            <div class="header"><span>Unique IPs</span><i class="fas fa-network-wired"></i></div>
            <p class="value"><%= uniqueIps %></p>
        </div>
    </section>

    <div class="dashboard-main-grid">
      <main class="main-content">
        <section class="table-card">
          <h2 class="card-header">Top 5 Most Downloaded Notes</h2>
          <div class="table-wrapper"> <table class="dashboard-table">
              <thead><tr><th>Title</th><th>Downloads</th><th>Course</th></tr></thead>
              <tbody>
                <% topNotes.forEach(note => { %>
                <tr><td><%= note.title %></td><td><%= note.downloadCount %></td><td><%= note.course %></td></tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </section>
        
      </main>

      <aside class="right-sidebar">
        <section class="sidebar-card">
          <h2 class="card-header">User Verification</h2>
          <div class="chart-container"><canvas id="userVerificationChart"></canvas></div>
        </section>
        
        <section class="sidebar-card">
          <h2 class="card-header">Notes by Course</h2>
           <div class="table-wrapper"> <table class="dashboard-table">
              <tbody>
                <% courseWise.forEach(row => { %>
                  <tr><td><%= row._id %></td><td><%= row.notes %> notes</td></tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </section>
      </aside>
    </div>
  </div>
</div>

<script>
    const ctx = document.getElementById('userVerificationChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Verified', 'Unverified'],
            datasets: [{
                data: [<%= verifiedUsers %>, <%= unverifiedUsers %>],
                backgroundColor: ['#4f46e5', '#e5e7eb'],
                borderColor: '#ffffff',
                borderWidth: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            cutout: '70%'
        }
    });
</script>