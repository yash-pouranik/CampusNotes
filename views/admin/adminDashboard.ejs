<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard â€¢ CampusNotes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link rel="stylesheet" href="/css/admin.css">


</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <h1><i class="fa-solid fa-gauge-high" style="color:var(--accent2)"></i> Admin Dashboard</h1>

    <a href="/logout">
      <button class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </a>
  </div>

  <!-- MAIN STAT CARDS -->
  <div class="grid grid-4">
    <div class="card stat">
      <div>
        <p class="stat-title">Total Users</p>
        <div class="stat-number"><%= totalUsers %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Total Notes</p>
        <div class="stat-number"><%= totalNotes %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-file-lines"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Total Downloads</p>
        <div class="stat-number"><%= totalDownloads %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-download"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Downloads (7d)</p>
        <div class="stat-number"><%= downloadsLast7Days %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-calendar-week"></i></div>
    </div>
  </div>



  <!-- UNIQUE TRAFFIC -->
  <h2 class="sec-title">Unique Traffic</h2>
  <div class="grid grid-3">
    <div class="card stat">
      <div>
        <p class="stat-title">Unique Downloads</p>
        <div class="stat-number"><%= totalUniqueDownloads %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-fingerprint"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Unique Sessions</p>
        <div class="stat-number"><%= uniqueSessions %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-stopwatch"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Unique IPs</p>
        <div class="stat-number"><%= uniqueIps %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-network-wired"></i></div>
    </div>
  </div>



  <!-- USER ENGAGEMENT -->
  <h2 class="sec-title">User Engagement</h2>
  <div class="grid grid-3">
    <div class="card stat">
      <div>
        <p class="stat-title">New Signups (7d)</p>
        <div class="stat-number"><%= newSignups %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-user-plus"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Verified Users</p>
        <div class="stat-number"><%= verifiedUsers %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">Unverified Users</p>
        <div class="stat-number"><%= unverifiedUsers %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-circle-xmark"></i></div>
    </div>
  </div>



  <!-- CONTENT & MODERATION -->
  <h2 class="sec-title">Content & Moderation</h2>
  <div class="grid grid-2">
    <div class="card stat">
      <div>
        <p class="stat-title">Pending Verification</p>
        <div class="stat-number"><%= notesPendingVerification %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-hourglass-half"></i></div>
    </div>

    <div class="card stat">
      <div>
        <p class="stat-title">New Note Uploads (7d)</p>
        <div class="stat-number"><%= newNoteUploads %></div>
      </div>
      <div class="stat-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
    </div>
  </div>




  <!-- TOP CONTRIBUTORS -->
  <h2 class="sec-title">Top Contributors</h2>
  <div class="grid grid-3">
    <% topContributors.forEach(user => { %>
      <div class="card contrib">
        <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="">
        <h3 style="margin:6px 0;"><%= user.name %></h3>
        <p style="color:var(--muted);">@<%= user.username %></p>
        <p style="margin-top:6px; color:var(--accent2); font-weight:700;">
          <i class="fa-solid fa-file-pen"></i> <%= user.notesCount %>
        </p>
      </div>
    <% }) %>
  </div>



  <!-- TOP NOTES TABLE -->
  <h2 class="sec-title">Top Notes</h2>
  <div class="table-wrap card">
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Course</th>
          <th>Downloads</th>
        </tr>
      </thead>
      <tbody>
        <% topNotes.forEach(note => { %>
          <tr>
            <td><%= note.title %></td>
            <td><%= note.course %></td>
            <td><i class="fa-solid fa-download" style="color:var(--accent)"></i> <%= note.downloadCount %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>



  <!-- CHART -->
  <h2 class="sec-title">Notes by Course</h2>
  <div class="chart-box">
    <canvas id="courseChart"></canvas>
  </div>



  <!-- RECENT USERS -->
  <h2 class="sec-title">Recent Users</h2>
  <div class="table-wrap card">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Joined</th>
        </tr>
      </thead>
      <tbody>
        <% fiveLastUsers.forEach(u => { %>
          <tr>
            <td><%= u.name %></td>
            <td>@<%= u.username %></td>
            <td><%= new Date(u.createdAt).toLocaleDateString() %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>



  <!-- RECENT DOWNLOADS -->
  <h2 class="sec-title">Recent Downloads</h2>
  <div class="table-wrap card">
    <table>
      <thead>
        <tr>
          <th>Note</th>
          <th>Downloaded At</th>
        </tr>
      </thead>
      <tbody>
        <% LastDownloads.forEach(dl => { %>
          <tr>
            <td><%= dl.note ? dl.note.title : 'Unknown' %></td>
            <td><%= new Date(dl.downloadedAt).toLocaleString('en-IN', { timeZone:'Asia/Kolkata' }) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

</div>


<script>
  const ctx = document.getElementById("courseChart").getContext("2d");
  const data = <%- JSON.stringify(courseWise) %>;

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(c => c._id),
      datasets: [{
        label: "Notes",
        data: data.map(c => c.notes),
        backgroundColor: "rgba(138,47,255,0.5)",
        borderRadius: 8
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, ticks:{ color:"#cfe3ff" } },
        x: { ticks:{ color:"#cfe3ff" } }
      }
    }
  });
</script>

</body>
</html>
