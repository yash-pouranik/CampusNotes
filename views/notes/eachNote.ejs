<link rel="stylesheet" href="/css/eachNoteCss.css?v=07">

<div class="note-page-container">
  
  <div class="note-layout-grid">
    
    <!-- LEFT COLUMN: PREVIEWER -->
    <main class="note-viewer-column">
      <div class="preview-card">
        <% if (note.fileUrl.includes('drive.google.com')) { %>
          <%# Google Drive Link Logic %>
          <%
            let fileId = null;
            try {
              const url = new URL(note.fileUrl);
              const pathParts = url.pathname.split('/');
              const idIndex = pathParts.indexOf('d');
              if (idIndex !== -1 && pathParts.length > idIndex + 1) {
                fileId = pathParts[idIndex + 1];
              }
            } catch (e) {
              console.error('Invalid Google Drive URL', e);
            }
          %>
      
          <% if (fileId) { %>
            <iframe 
              src="https://docs.google.com/gview?url=https://drive.google.com/uc?export=download&id=<%= fileId %>&embedded=true" 
              class="note-preview-frame" 
              frameborder="0">
            </iframe>
          <% } else { %>
            <div class="no-preview-box">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <p>Invalid Google Drive link format.</p>
            </div>
          <% } %>
      
        <% } else if (note.fileUrl.toLowerCase().endsWith('.pdf')) { %>
          <iframe 
            src="<%= note.fileUrl %>#toolbar=0" 
            class="note-preview-frame">
          </iframe>
      
        <% } else if (/\.(jpg|jpeg|png|gif|webp|avif)$/i.test(note.fileUrl)) { %>
          <img src="<%= note.fileUrl %>" class="note-preview-img" alt="Note Preview">
          
        <% } else { %>
          <div class="no-preview-box">
            <i class="fa-solid fa-file-circle-question"></i>
            <p>No preview available for this file type.</p>
            <a href="/notes/<%= note._id %>/download" class="btn-download-fallback">Download to View</a>
          </div>
        <% } %>
      </div>
      

    </main>

    <!-- RIGHT COLUMN: SIDEBAR -->
<!-- RIGHT COLUMN: SIDEBAR -->
<aside class="note-sidebar-column">
  <div class="sidebar-sticky-wrapper">

    <!-- MAIN INFO CARD -->
    <div class="note-info-card">

      <!-- TITLE -->
      <h1 class="note-title"><%= note.title %></h1>

      <!-- META ROW -->
      <div class="note-meta-row">
        <a href="/profile/<%= note.uploadedBy?._id %>" class="uploader-badge">

          <div class="uploader-avatar">
            <%= note.uploadedBy?.name?.charAt(0)?.toUpperCase() || 'U' %>
          </div>

          <div class="uploader-meta">
            <span class="uploader-name"><%= note.uploadedBy?.name || 'Unknown' %></span>

            <% if (note.uploadedBy?.roles?.isModerator) { %>
              <img src="/images/blueCheckmark.svg" alt="Mod" class="verified-icon">
            <% } else if (note.uploadedBy?.roles?.isDev) { %>
              <img src="/images/icons8-checkmark.svg" alt="Dev" class="verified-icon">
            <% } %>
          </div>

        </a>

        <span class="meta-dot">Â·</span>

        <span class="meta-date">
          <%= note.createdAt?.toLocaleDateString('en-IN', {day:'numeric', month:'short', year:'numeric'}) %>
        </span>

      </div>

      <!-- ACTION BUTTONS -->
      <div class="action-buttons-grid">
        <a href="/notes/<%= note._id %>/download" class="btn-block btn-primary-neon">
          <i class="fa-solid fa-download"></i> Download
        </a>

        <form action="/notes/<%= note._id %>/upvote" method="POST" style="width: 100%;">
          <button class="btn-block btn-secondary-neon">
            <i class="fa-solid fa-thumbs-up"></i>
            <span><%= note.upvotes.length %></span>
          </button>
        </form>
      </div>

      <!-- DETAILS CARD -->
      <div class="note-details-card">
        <h3>Details</h3>

        <ul class="details-list">
          <li>
            <span class="label">Subject</span>
            <span class="value"><%= note.subject?.name || 'N/A' %></span>
          </li>
          <li>
            <span class="label">Course</span>
            <span class="value"><%= note.course || 'N/A' %></span>
          </li>
          <li>
            <span class="label">Semester</span>
            <span class="value"><%= note.semester || 'N/A' %></span>
          </li>
        </ul>

        <!-- DESCRIPTION -->
        <div class="description-box">
          <span class="label">Description</span>
          <p class="desc-text"><%= note.description || 'No description provided.' %></p>
        </div>

        <!-- OWNER CONTROLS -->
        <% if (typeof currUser !== 'undefined' &&
              (currUser._id.toString() === note.uploadedBy?._id.toString() ||
               currUser.roles?.isModerator ||
               currUser.roles?.isDev)) { %>
          <div class="owner-controls">
            <a href="/notes/<%= note._id %>/edit" class="btn-icon-text">
              <i class="fa-solid fa-pen"></i> Edit
            </a>

            <button type="button"
                    class="btn-icon-text text-red"
                    onclick="openDeleteModal('/notes/<%= note._id %>?_method=DELETE')">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </div>
        <% } %>

      </div>

      <!-- DISCLAIMER -->
      <div class="disclaimer-text">
        <strong>Disclaimer:</strong> Use for reference only. CampusNotes is not responsible for grades.
      </div>

    </div>

  </div>
</aside>


    

  </div>

        <!-- AI Assistant (Moved here for better width) -->
      <div class="ai-assistant-card ai-assistant-container" style="display: none; margin-top: 2rem;">
         <div class="ai-header">
           <div class="ai-icon-pulse">
             <i class="fa-solid fa-robot"></i>
           </div>
           <div class="ai-title-group">
              <h4>Volt AI</h4>
              <span class="ai-badge">BETA</span>
           </div>
         </div>
         
         <button id="summarize-btn" class="btn-ai-action">
           <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Summary
         </button>
         <div id="summary-output" class="ai-response-box"></div>

         <div class="ai-chat-box">
           <label for="ai-question">Ask about this note</label>
           <div class="input-group">
             <input type="text" id="ai-question" placeholder="e.g. Explain the main concept...">
             <button id="ask-ai-btn" class="btn-ai-send">
               <i class="fa-solid fa-paper-plane"></i>
             </button>
           </div>
           <div id="answer-output" class="ai-response-box"></div>
         </div>
      </div>

      <div id="handwritten-notice" class="notice-card warning" style="display: none; margin-top: 2rem;">
         <i class="fa-solid fa-pen-nib"></i>
         <div>
           <strong>AI Unavailable</strong>
           <p>This appears to be a handwritten note. AI features are currently limited to typed documents.</p>
         </div>
      </div>

  <!-- Recommended Section -->
  <section class="recommended-section">
    <div class="section-divider">
       <span>More Like This</span>
    </div>

    <div class="rec-group">
      <h2>More in <%= note.subject.name %></h2>
      <% if (subjectNotes.length === 0) { %>
        <p class="empty-msg">No other notes in this subject yet.</p>
      <% } else { %>
        <div class="rec-grid">
          <% subjectNotes.forEach(note => { %>
            <a href="/notes/<%= note._id %>" class="rec-card">
              <div class="rec-icon">
                <i class="fa-regular fa-file-lines"></i>
              </div>
              <div class="rec-info">
                <h4><%= note.title %></h4>
                <div class="rec-meta">
                  <span><%= note.uploadedBy?.name || 'Unknown' %></span>
                  <span><i class="fa-solid fa-download"></i> <%= note.downloadCount %></span>
                </div>
              </div>
            </a>
          <% }) %>
        </div>
      <% } %>
    </div>
    
    <div class="rec-group" style="margin-top: 2rem;">
      <h2>More in Semester <%= note.semester %></h2>
      <% if (semNotes.length === 0) { %>
        <p class="empty-msg">No other notes in this semester yet.</p>
      <% } else { %>
        <div class="rec-grid">
          <% semNotes.forEach(note => { %>
            <a href="/notes/<%= note._id %>" class="rec-card">
              <div class="rec-icon">
                <i class="fa-regular fa-file-lines"></i>
              </div>
              <div class="rec-info">
                <h4><%= note.title %></h4>
                <div class="rec-meta">
                  <span><%= note.uploadedBy?.name || 'Unknown' %></span>
                  <span><i class="fa-solid fa-download"></i> <%= note.downloadCount %></span>
                </div>
              </div>
            </a>
          <% }) %>
        </div>
      <% } %>
    </div>

  </section>

</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="deleteModal" class="neon-modal-overlay">
  <div class="neon-modal">
    <div class="modal-icon warning">
      <i class="fa-solid fa-trash-can"></i>
    </div>
    <h2>Delete Note?</h2>
    <p>This action cannot be undone. Are you sure?</p>

    <div class="modal-buttons">
      <button id="cancelDelete" class="btn-modal-cancel">Cancel</button>

      <form id="deleteForm" method="POST">
        <button class="btn-modal-delete">Delete</button>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<script>
    const summarizeBtn = document.getElementById('summarize-btn');
    const summaryOutput = document.getElementById('summary-output');
    const askAiBtn = document.getElementById('ask-ai-btn');
    const aiQuestionInput = document.getElementById('ai-question');
    const answerOutput = document.getElementById('answer-output');
    const noteId = "<%= note._id %>";


    const aiContainer = document.querySelector('.ai-assistant-container');
    const handwrittenNotice = document.getElementById('handwritten-notice');
    const converter = new showdown.Converter();


    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await axios.get(`/api/notes/${noteId}/check-pdf`);
            if (res.data.isTyped) {
                aiContainer.style.display = 'block'; 
            } else {
                handwrittenNotice.style.display = 'flex'; 
                aiContainer.style.display = 'none'; 
            }
        } catch (error) {
            console.error("Could not check PDF type", error);
            handwrittenNotice.style.display = 'flex';
            handwrittenNotice.querySelector('p').textContent = 'Could not determine PDF type. AI Assistant is unavailable.';
            aiContainer.style.display = 'none';
        }
    });



    // --- Summarize Button Logic ---
    summarizeBtn.addEventListener('click', async () => {
        summaryOutput.innerHTML = '<div class="ai-loading"><i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...</div>';
        summarizeBtn.disabled = true;
        try {
            const response = await axios.post(`/api/notes/${noteId}/ask`, {
                question: "Summarize this document in 5 key bullet points."
            }, { withCredentials: true });
            summaryOutput.innerHTML = converter.makeHtml(response.data.answer); 
        } catch (error) {
            console.error(error);
            if (error.response && error.response.status === 401) {
                window.location.href = '/login-n';
            } else {
                summaryOutput.textContent = 'Sorry, an error occurred while generating the summary.';
            }
        } finally {
            summarizeBtn.disabled = false;
        }
    });

    // --- Ask Question Button Logic ---
    askAiBtn.addEventListener('click', async () => {
        const question = aiQuestionInput.value;
        if (!question) {
            alert('Please enter a question.');
            return;
        }

        answerOutput.innerHTML = '<div class="ai-loading"><i class="fa-solid fa-circle-notch fa-spin"></i> Finding answer...</div>';
        askAiBtn.disabled = true;
        try {
            const response = await axios.post(`/api/notes/${noteId}/ask`, { question: question }, { withCredentials: true });
            answerOutput.innerHTML = converter.makeHtml(response.data.answer);
        } catch (error) {
             console.error(error);
            if (error.response && error.response.status === 401) {
                window.location.href = '/login-n';
            } else {
                answerOutput.textContent = 'Sorry, an error occurred while getting the answer.';
            }
        } finally {
            askAiBtn.disabled = false;
        }
    });
</script>


<script>
  const deleteModal = document.getElementById("deleteModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const deleteForm = document.getElementById("deleteForm");

  function openDeleteModal(actionUrl) {
    deleteForm.action = actionUrl;
    deleteModal.style.display = "flex";
  }

  cancelDelete.addEventListener("click", () => {
    deleteModal.style.display = "none";
  });

  // Close modal when clicked outside
  deleteModal.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
      deleteModal.style.display = "none";
    }
  });

</script>