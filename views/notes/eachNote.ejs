<link rel="stylesheet" href="/css/eachNoteCss.css?v=04">


<section class="note-detail-container">
  <div class="note-card-new">

    <header class="new-header">
      <h1 class="new-title"><%= note.title %></h1>
      <div class="new-meta">
        <a href="/profile/<%= note.uploadedBy?._id %>" class="uploader-link">
          <span class="uploader-name"><%= note.uploadedBy?.name || 'Unknown' %></span>
          <% if (note.uploadedBy?.roles.isModerator) { %>
            <img src="/images/blueCheckmark.svg" alt="Moderator" class="role-badge">
          <% } %>
        </a>
        <span class="meta-dot">Â·</span>
        <span class="meta-date"><%= note.createdAt?.toLocaleDateString('en-IN', {day:'numeric', month:'short', year:'numeric'}) %></span>
        <span class="meta-dot">Â·</span>
        <span class="meta-down"><%= note.downloadCount %> <i class="fa-solid fa-download"></i></span>
      </div>
    </header>

    <div class="action-bar">
      <a href="/notes/<%= note._id %>/download" class="btn-action btn-download-new">
        <i class="fa-solid fa-download"></i>
      </a>
      <form action="/notes/<%= note._id %>/upvote" method="POST" style="margin: 0;" style="width: 100%;">
        <button class="btn-action btn-upvote-new">
          <i class="fa-solid fa-thumbs-up"></i> 
          <span><%= note.upvotes.length %></span>
        </button>
      </form>
    </div>

    <div class="note-preview-new">
      <% if (note.fileUrl.toLowerCase().endsWith('.pdf')) { %>
        <iframe src="<%= note.fileUrl %>#toolbar=0" class="note-preview-frame-new"></iframe>
      <% } else if (/\.(jpg|jpeg|png|gif)$/i.test(note.fileUrl)) { %>
        <img src="<%= note.fileUrl %>" class="note-preview-frame-new">
      <% } else { %>
        <div class="no-preview-text">No preview available.</div>
      <% } %>
    </div>
    
    <div class="disclaimer-box" >
        <strong>Disclaimer:</strong> Please use these notes as a reference only.
        Do not rely solely on them for your academic results. CampusNotes is not
        responsible for your grades.
    </div>
    
    <details class="details-collapsible">
      <summary class="details-summary">
        View Details & Description
      </summary>
      <div class="details-content">
        <ul>
          <li><strong>Subject:</strong> <%= note.subject?.name || 'N/A' %></li>
          <li><strong>Course:</strong> <%= note.course || 'N/A' %></li>
          <li><strong>Semester:</strong> <%= note.semester || 'N/A' %></li>
        </ul>
        <p class="description-text">
          <%= note.description || 'No description provided.' %>
        </p>
      </div>
    </details>

    <div id="handwritten-notice" style="display: none; margin-top: 30px; background: #fef3c7; color: #92400e; border-left: 5px solid #f59e0b; padding: 1rem 1.5rem; border-radius: 6px;">
      <h4 style="margin: 0 0 10px 0;">ðŸ¤– AI Assistant Notice</h4>
      <p style="margin: 0;">The AI Assistant feature is not available for handwritten notes at the moment. It only works with typed (digital) PDFs.</p>
    </div>

    <div class="ai-assistant-container">
      <div class="ai-header">
        <div class="ai-header-icon"><img src="/images/ai_f.png" alt="" class="ai-header-icon"></div>
        <h4>VOLT AI</h4>
      </div>
      <button id="summarize-btn" class="ai-btn">âœ¨ Generate Smart Summary</button>
      <div id="summary-output" class="ai-output">Click the button to get a summary...</div>
      <div class="form-group">
        <label for="ai-question" style="font-weight: 600; font-size: 0.95rem; color: #222;">Ask Anything from this Note</label>
        <input type="text" id="ai-question" placeholder="e.g., Explain paging in OS?">
        <button id="ask-ai-btn" class="ai-btn">Ask AI</button>
      </div>
      <div id="answer-output" class="ai-output">Your answer will appear here...</div>
    </div>

  </div>
</section>
<hr>
<section class="recommendedNotes" style="color: white;">
  <div class="subjects" style="margin-bottom: 2rem;">
    <h1>More in <%= note.subject.name %></h1>
    <% if (subjectNotes.length === 0) { %>
      <p style="text-align: center; font-size: 1.1rem; color: #666;">No SVVV notes uploaded yet.</p>
    <% } else { %>
      <div class="note-grid">
      <% subjectNotes.forEach(note => { %>
          <div class="note-grid-card"> 
            <h3 style="margin: 0;"><%= note.title %></h3>
            <p><strong>Subject:</strong> <%= note.subject?.name || 'N/A' %></p>
            <p><strong><i class="fa-solid fa-download"></i></strong> <%= note.downloadCount %></p>
            <a href="/notes/<%= note._id %>" class="view-link">ðŸ“„ View Note</a>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
  <hr>
  <div class="semester">
    <h1>More in Semester - <%= note.semester %></h1>
    <% if (semNotes.length === 0) { %>
      <p style="text-align: center; font-size: 1.1rem; color: #666;">No SVVV notes uploaded yet.</p>
    <% } else { %>
      <div class="note-grid">
      <% semNotes.forEach(note => { %>
          <div class="note-grid-card"> 
            <h3 style="margin: 0;"><%= note.title %></h3>
            <p><strong>Subject:</strong> <%= note.subject?.name || 'N/A' %></p>
            <p><strong><i class="fa-solid fa-download"></i></strong> <%= note.downloadCount %></p>
            <a href="/notes/<%= note._id %>" class="view-link">ðŸ“„ View Note</a>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
  </div>

</section>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<script>
    const summarizeBtn = document.getElementById('summarize-btn');
    const summaryOutput = document.getElementById('summary-output');
    const askAiBtn = document.getElementById('ask-ai-btn');
    const aiQuestionInput = document.getElementById('ai-question');
    const answerOutput = document.getElementById('answer-output');
    const noteId = "<%= note._id %>";


    const aiContainer = document.querySelector('.ai-assistant-container');
    const handwrittenNotice = document.getElementById('handwritten-notice');
    const converter = new showdown.Converter();


    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await axios.get(`/api/notes/${noteId}/check-pdf`);
            if (res.data.isTyped) {
                aiContainer.style.display = 'block'; // AI wala section dikhayein
            } else {
                handwrittenNotice.style.display = 'block'; // Handwritten wala message dikhayein
                aiContainer.style.display = 'none'; // AI wala section chupa dein
            }
        } catch (error) {
            console.error("Could not check PDF type", error);
            // Agar check fail ho to AI section chupa dein
            handwrittenNotice.style.display = 'block';
            handwrittenNotice.querySelector('p').textContent = 'Could not determine PDF type. AI Assistant is unavailable.';
            aiContainer.style.display = 'none';
        }
    });



    // --- Summarize Button Logic ---
    summarizeBtn.addEventListener('click', async () => {
        summaryOutput.innerHTML = 'ðŸ§  Thinking... generating summary...';
        summarizeBtn.disabled = true;
        try {
            const response = await axios.post(`/api/notes/${noteId}/ask`, {
                question: "Summarize this document in 5 key bullet points."
            }, { withCredentials: true });
            summaryOutput.innerHTML = converter.makeHtml(response.data.answer); 
        } catch (error) {
            console.error(error);
            // âœ… YEH BADLAV KAREIN
            if (error.response && error.response.status === 401) {
                // Agar user logged in nahi hai, to use login page par bhejein
                window.location.href = '/login-n';
            } else {
                summaryOutput.textContent = 'Sorry, an error occurred while generating the summary.';
            }
        } finally {
            summarizeBtn.disabled = false;
        }
    });

    // --- Ask Question Button Logic ---
    askAiBtn.addEventListener('click', async () => {
        const question = aiQuestionInput.value;
        if (!question) {
            alert('Please enter a question.');
            return;
        }

        answerOutput.innerHTML = 'ðŸ§  Thinking... finding an answer...';
        askAiBtn.disabled = true;
        try {
            const response = await axios.post(`/api/notes/${noteId}/ask`, { question: question }, { withCredentials: true });
            answerOutput.innerHTML = converter.makeHtml(response.data.answer);
        } catch (error) {
             console.error(error);
            // âœ… YEH BADLAV BHI KAREIN
            if (error.response && error.response.status === 401) {
                // Agar user logged in nahi hai, to use login page par bhejein
                window.location.href = '/login-n';
            } else {
                answerOutput.textContent = 'Sorry, an error occurred while getting the answer.';
            }
        } finally {
            askAiBtn.disabled = false;
        }
    });
</script>