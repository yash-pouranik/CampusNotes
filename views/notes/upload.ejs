

<link rel="stylesheet" href="/css/eachNoteCss.css">

<div class="upload-form-container">
  <h2>üì§ Upload New Note</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    
    <div class="form-group">
      <label for="title">Title *</label>
      <input type="text" name="title" id="title" required>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea name="description" id="description" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="subject">Subject *</label>
      <div class="dropdown" data-name="subject">
  <div class="dropdown-selected">-- Select Subject --</div>

  <div class="dropdown-menu">
    <% subjects.forEach(s => { %>
      <div class="dropdown-item" data-value="<%= s._id %>"><%= s.name %></div>
    <% }) %>

    <div class="dropdown-item" data-value="other">‚ûï Add New Subject</div>
  </div>

  <input type="hidden" name="subject" id="subject">
</div>

    </div>

    <!-- Hidden input for new subject -->
    <div class="form-group" id="newSubjectGroup" style="display:none;">
      <label for="newSubject">New Subject Name *</label>
      <input type="text" name="newSubject" id="newSubject" placeholder="Enter new subject">
    </div>

    <div class="form-group">
      <label for="course">Course *</label>
      <div class="dropdown" data-name="course">
  <div class="dropdown-selected">-- Select Course --</div>

  <div class="dropdown-menu">
    <% courses.forEach(c => { %>
      <div class="dropdown-item" data-value="<%= c %>"><%= c %></div>
    <% }) %>
  </div>

  <!-- hidden input (actual submitted value) -->
  <input type="hidden" name="course" id="course">
</div>

    </div>


    <div class="form-group">
      <label for="semester">Semester *</label>
      <div class="dropdown" data-name="semester">
  <div class="dropdown-selected">-- Select Semester --</div>

  <div class="dropdown-menu">
    <% semester.forEach(s => { %>
      <div class="dropdown-item" data-value="<%= s %>"><%= s %></div>
    <% }) %>
  </div>

  <input type="hidden" name="semester" id="semester">
</div>

    </div>



    <div class="form-group">
      <div class="form-group">
        <label for="file">Upload File *</label>

        <div class="custom-file-input" id="fileInputBox">
          <i class="fa-solid fa-file-pdf"></i>
          <span id="fileLabel">Select PDF...</span>
        </div>

        <input type="file" name="file" id="file" accept="application/pdf" required>

        <p class="error-text" id="fileError">‚ùå File must be a PDF and less than 10MB.</p>
      </div>
      <p class="error-text" id="fileError">‚ùå File must be a PDF and less than 5MB.</p>
    </div>

    <button type="submit" class="form-submit-btn">Upload Note</button>
  </form>

  <!-- Progress bar -->



</div>

<!-- progress container (place near bottom of upload page) -->
<div id="progressContainer">
  <div id="progressInner">
    <div style="display:flex; align-items:center; gap:14px; width:100%;">
      <div style="flex:1;">
        <div style="font-weight:700; font-size:1.05rem;">Uploading file...</div>
        <div style="color:var(--muted); font-size:0.9rem;">Please do not close this tab.</div>
      </div>
      <div style="min-width:140px; text-align:right;">
        <div id="progressText">0%</div>
      </div>
    </div>

    <progress id="progressBar" value="0" max="100"></progress>
    <div style="display:flex; gap:10px; margin-top:6px;">
      <button class="btn" id="cancelUploadBtn" type="button">Cancel</button>
    </div>
  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>


    const form = document.getElementById("uploadForm");
    const fileInput = document.getElementById("file");
    const fileError = document.getElementById("fileError");
  
  // show/hide helpers
function showProgress() { 
  document.getElementById('progressContainer').style.display = 'flex'; 
}
function hideProgress() { 
  document.getElementById('progressContainer').style.display = 'none'; 
}

const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

form.addEventListener('submit', async function(e){
  e.preventDefault();
  if (fileError.style.display === "block" || !fileInput.files[0]) {
    alert("Please select a valid PDF file.");
    return;
  }
  showProgress();

  try {
    // Get signature from backend
    const sigRes = await axios.get('/api/upload-signature');
    const { signature, timestamp, cloudName, apiKey } = sigRes.data;
    const UPLOAD_URL = `https://api.cloudinary.com/v1_1/${cloudName}/raw/upload`;

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append("file", file);
    formData.append("api_key", apiKey);
    formData.append("timestamp", timestamp);
    formData.append("signature", signature);
    formData.append("folder", "campusNotes");

    const cloudRes = await axios.post(UPLOAD_URL, formData, {
      headers: { "Content-Type": "multipart/form-data" },
      onUploadProgress: (ev) => {
        const percent = Math.round((ev.loaded * 100) / ev.total);
        progressBar.value = percent;
        progressText.innerText = percent + '%';
      }
    });

    const uploadedFileUrl = cloudRes.data.secure_url;
    // send to server
    const noteDetails = {
      title: form.title.value,
      description: form.description.value,
      subject: form.subject.value,
      newSubject: form.newSubject.value,
      course: form.course.value,
      semester: form.semester.value,
      fileUrl: uploadedFileUrl
    };

    const saveNoteResponse = await axios.post('/upload', noteDetails);
    if (saveNoteResponse.data.success) {
      hideProgress();
      alert('‚úÖ Upload successful! Note has been sent for verification.');
      window.location.href = saveNoteResponse.data.redirectUrl;
    }
  } catch(err) {
    console.error(err);
    hideProgress();
    alert('‚ùå Upload failed: ' + (err.response?.data?.error || err.message));
  }
});

// Cancel upload (optional)
// If you want to actually cancel the axios upload you'd need an AbortController or cancel token.
document.getElementById('cancelUploadBtn').addEventListener('click', () => {
  hideProgress();
});




</script>

<script>
document.querySelectorAll(".dropdown").forEach(drop => {

  const selected = drop.querySelector(".dropdown-selected");
  const menu = drop.querySelector(".dropdown-menu");
  const items = drop.querySelectorAll(".dropdown-item");
  const hidden = drop.querySelector("input[type='hidden']");

  // open / close
  selected.addEventListener("click", () => {
    drop.classList.toggle("open");
  });

  // choose item
  items.forEach(item => {
    item.addEventListener("click", () => {
      const value = item.dataset.value;
      const text = item.textContent;

      selected.innerHTML = text;
      hidden.value = value;

      items.forEach(i => i.classList.remove("active"));
      item.classList.add("active");

      drop.classList.remove("open");

      // Special case: Add New Subject
      if(value === "other") {
        document.getElementById("newSubjectGroup").style.display = "block";
      } else if (drop.dataset.name === "subject") {
        document.getElementById("newSubjectGroup").style.display = "none";
      }
    });
  });

});

// click outside to close
document.addEventListener("click", e => {
  document.querySelectorAll(".dropdown.open").forEach(dd => {
    if (!dd.contains(e.target)) dd.classList.remove("open");
  });
});


const fileBox = document.getElementById("fileInputBox");
const fileLabel = document.getElementById("fileLabel");

fileBox.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", () => {
  if (fileInput.files.length > 0) {
    fileLabel.textContent = fileInput.files[0].name;
    fileLabel.style.color = "#e6eef8"; // make text visible
  } else {
    fileLabel.textContent = "Select PDF...";
    fileLabel.style.color = "var(--muted)";
  }
});


</script>
