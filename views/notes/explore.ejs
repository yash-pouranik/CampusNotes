<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/css/explore.css">
</head>

  
  <!-- HEADER -->
  <header class="page-head">
    <div class="title-wrap">
      <h1>Explore SVVV Notes</h1>
      <div class="title-sub">Community-uploaded notes — @SVVV</div>
    </div>

    <div class="controls">
      <form id="searchForm" class="search" method="GET" action="/explore">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/></svg>
        <input type="search" name="q" placeholder="Search..." value="<%= query || '' %>">
      </form>

      <a href="/most-voted" class="btn desktop-only">Most Voted</a>
    </div>
  </header>

  <!-- ⭐ NEW TOP FILTER BAR ⭐ -->
  <form method="GET" action="/explore" class="top-filters">

    <input type="text" name="q" placeholder="Search..." value="<%= query || '' %>">

    <select name="course">
      <option value="">Course</option>
      <% ["B.Tech CSE","B.Tech IT","B.Tech ECE","B.Tech ME","MBA","BBA","MCA","BCA"].forEach(c => { %>
        <option value="<%= c %>" <%= course === c ? "selected" : "" %>><%= c %></option>
      <% }) %>
    </select>

    <select name="semester">
      <option value="">Semester</option>
      <% ["I","II","III","IV","V","VI","VII","VIII","IX","X"].forEach(s => { %>
        <option value="<%= s %>" <%= semester === s ? "selected" : "" %>><%= s %></option>
      <% }) %>
    </select>


    <button type="submit" class="btn">Apply</button>
    <button type="button" id="resetBtn" class="btn">Reset</button>

  </form>


  <!-- MAIN CONTENT -->
  <% if (notes.length === 0) { %>
    <div style="text-align:center; padding:40px; color:var(--muted);">
      No SVVV notes uploaded yet.
    </div>
  <% } else { %>

  <div class="note-grid" id="noteGrid">
    <% notes.forEach(note => { %>

      <article class="card">

        <div class="card-top">
          

          <div>
            <h3 class="title"><%= note.title %></h3>
            <div class="subtitle"><%= note.subject?.name || 'General' %> • <%= note.course %></div>
          </div>
        </div>

        <div class="card-body">
          <div style="display:flex; gap:8px;">
            <div class="tag"><i class="fa-solid fa-download"></i> &nbsp;<strong><%= note.downloadCount %></strong></div>
            <div class="tag"><strong><%= note.createdAt?.toDateString() %></strong></div>
          </div>
        </div>

        <div class="card-footer">
          <a class="view-btn" href="/notes/<%= note._id %>">View</a>

          <div class="badge">
            By <span style="color:var(--accent); margin-left:6px;"><%= note.uploadedBy?.username %></span>

            <% if (note.uploadedBy?.roles?.isModerator) { %>
              <img src="/images/blueCheckmark.svg" style="width:18px;margin-left:6px;">
            <% } else if (note.uploadedBy?.roles?.isDev) { %>
              <img src="/images/icons8-checkmark.svg" style="width:18px;margin-left:6px;">
            <% } else if (note.uploadedBy?.verification?.verified) { %>
              <span style="color:#56ff9a;margin-left:6px;">✔</span>
            <% } %>

          </div>
        </div>

      </article>

    <% }) %>
  </div>

  <% } %>


  <!-- LOAD MORE -->
  <div class="load-more-wrap">
    <% if (currentPage < totalPages) { %>
      <button id="loadMoreBtn" class="load-more">Load more</button>
    <% } %>
  </div>


<script>
  // RESET FILTERS
  document.getElementById('resetBtn')?.addEventListener('click', () => {
    window.location.href = "/explore";
  });

  // LOAD MORE
  let currentPage = <%= currentPage %>;
  const totalPages = <%= totalPages %>;
  const loadMoreBtn = document.getElementById("loadMoreBtn");
  const noteGrid = document.getElementById("noteGrid");

  async function appendNotes() {
    currentPage++;

    const params = new URLSearchParams({
      q: "<%= query || '' %>",
      course: "<%= course || '' %>",
      semester: "<%= semester || '' %>",
      visibility: "<%= visibility || '' %>",
      page: currentPage
    });

    const res = await fetch("/explore?" + params.toString(), {
      headers: { "Accept": "application/json" }
    });

    const data = await res.json();

    data.notes.forEach(note => {
      const uploader = note.uploadedBy?.username || "Unknown";

      const badge = 
        note.uploadedBy?.roles?.isModerator
        ? `<img src="/images/blueCheckmark.svg" style="width:18px;margin-left:6px;">`
        : note.uploadedBy?.roles?.isDev
        ? `<img src="/images/icons8-checkmark.svg" style="width:18px;margin-left:6px;">`
        : note.uploadedBy?.verification?.verified
        ? `<span style="color:#56ff9a;margin-left:6px;">✔</span>`
        : "";

      const avatar = note.uploadedBy?.avatar
        ? `<img src="${note.uploadedBy.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`
        : `<span>${uploader[0]}</span>`;

      const html = `
        <article class="card">
          <div class="card-top">
            <div class="avatar">${avatar}</div>
            <div>
              <h3 class="title">${note.title}</h3>
              <div class="subtitle">${note.subject?.name || "General"} • ${note.course}</div>
            </div>
          </div>

          <div class="card-body">
            <div style="display:flex; gap:8px;">
              <div class="tag">Downloads: <strong>${note.downloadCount}</strong></div>
              <div class="tag">Added: <strong>${new Date(note.createdAt).toDateString()}</strong></div>
            </div>
          </div>

          <div class="card-footer">
            <a class="view-btn" href="/notes/${note._id}">View</a>

            <div class="badge">
              By <span style="color:var(--accent); margin-left:6px;">${uploader}</span>
              ${badge}
            </div>
          </div>
        </article>
      `;

      noteGrid.insertAdjacentHTML("beforeend", html);
    });

    if (currentPage >= totalPages) loadMoreBtn.remove();
  }

  loadMoreBtn?.addEventListener("click", appendNotes);
</script>
