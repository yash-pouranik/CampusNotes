<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- <link rel="stylesheet" href="/css/explore.css"> --> <!-- Legacy CSS disabled -->
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    
    <!-- Tailwind CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#FF5722", // Core Orange
              "primary-hover": "#F4511E",
              "accent-blue": "#3B82F6",
              "accent-green": "#22C55E",
              "accent-purple": "#A855F7",
              "background-dark": "#050505", // Deep Black
              "surface-dark": "#0A0A0A",
              "surface-dark-lighter": "#171717",
              "border-dark": "#27272A",
            },
            fontFamily: {
              "display": ["Inter", "system-ui", "sans-serif"]
            },
            animation: {
              "fade-in-up": "fadeInUp 0.5s ease-out forwards",
            },
            keyframes: {
              fadeInUp: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              }
            }
          },
        },
      }
    </script>
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      
      body {
        background-color: #050505 !important;
        color: #ffffff;
        font-family: 'Inter', sans-serif;
      }
      
      .glass-panel {
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid #27272A;
      }
      
      /* Form Select Customization */
      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
      }
    </style>
    </head>
    
    <div class="min-h-screen bg-background-dark font-display text-gray-300 antialiased pb-20">
    
      <!-- HERO SEARCH SECTION -->
      <header class="relative pt-32 pb-12 overflow-hidden">
        <!-- Background Gradients -->
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-primary/10 via-background-dark to-background-dark pointer-events-none"></div>
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-1 bg-gradient-to-r from-transparent via-primary/50 to-transparent blur-sm"></div>
        
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center space-y-6">
          <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight animate-fade-in-up">
            Explore <span class="text-primary">CampusNotes</span> Library
          </h1>
          <p class="max-w-2xl mx-auto text-lg text-gray-400 animate-fade-in-up" style="animation-delay: 0.1s;">
            Access verified handwritten notes, assignments, and study materials for <strong>B.Tech (CSE, IT)</strong> at SVVV.
          </p>
          
          <!-- MAIN SEARCH BAR -->
          <div class="max-w-2xl mx-auto mt-8 animate-fade-in-up" style="animation-delay: 0.2s;">
            <form id="headerSearchForm" method="GET" action="/explore" class="relative group">
              <div class="absolute inset-0 bg-primary/20 blur-xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              <div class="relative flex items-center bg-surface-dark border border-border-dark rounded-full shadow-2xl overflow-hidden focus-within:border-primary/50 focus-within:ring-1 focus-within:ring-primary/50 transition-all">
                <span class="pl-6 text-gray-500">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </span>
                <input 
                  type="search" 
                  name="q" 
                  value="<%= query || '' %>"
                  placeholder="Search by topic, subject, or author..." 
                  class="w-full bg-transparent border-none text-white placeholder-gray-500 px-4 py-4 focus:ring-0 focus:outline-none text-lg"
                >
                <div class="pr-2">
                    <button type="submit" class="p-2 bg-surface-dark-lighter hover:bg-primary text-gray-300 hover:text-white rounded-full transition-colors mr-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
              </div>
            </form>
          </div>
    
          <!-- FILTERS & ACTIONS -->
          <form method="GET" action="/explore" id="filterForm" class="flex flex-wrap items-center justify-center gap-4 mt-8 animate-fade-in-up" style="animation-delay: 0.3s;">
             <!-- Hidden Search Input for Sync -->
             <input type="hidden" id="filterSearchInput" name="q" value="<%= query || '' %>">
    
            <select name="course" class="bg-surface-dark border border-border-dark text-gray-300 text-sm rounded-lg focus:ring-primary focus:border-primary block p-2.5 px-4 pr-10 hover:border-gray-500 transition-colors cursor-pointer">
              <option value="">All Courses</option>
              <% ["B.Tech CSE","B.Tech IT","MBA","BBA","MCA","BCA"].forEach(c => { %>
                <option value="<%= c %>" <%= course === c ? "selected" : "" %>><%= c %></option>
              <% }) %>
            </select>
    
            <select name="semester" class="bg-surface-dark border border-border-dark text-gray-300 text-sm rounded-lg focus:ring-primary focus:border-primary block p-2.5 px-4 pr-10 hover:border-gray-500 transition-colors cursor-pointer">
              <option value="">All Semesters</option>
              <% ["I","II","III","IV","V","VI","VII","VIII","IX","X"].forEach(s => { %>
                <option value="<%= s %>" <%= semester === s ? "selected" : "" %>><%= s %></option>
              <% }) %>
            </select>
    
            <div class="flex gap-2">
                <button type="submit" class="px-4 py-2.5 bg-white text-black text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors">Apply</button>
                <button type="button" id="resetBtn" class="px-4 py-2.5 bg-surface-dark text-gray-400 border border-border-dark text-sm font-medium rounded-lg hover:text-white hover:bg-surface-dark-lighter transition-colors">Reset</button>
                <a href="/most-downloaded" class="px-4 py-2.5 bg-surface-dark text-accent-blue border border-border-dark text-sm font-medium rounded-lg hover:bg-blue-500/10 transition-colors flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">trending_up</span> Top
                </a>
            </div>
          </form>
    
        </div>
      </header>
    
      <!-- NOTES GRID SECTION -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        
        <% if (notes.length === 0) { %>
            <div class="flex flex-col items-center justify-center py-20 text-center border border-dashed border-border-dark rounded-xl bg-surface-dark/50">
              <div class="w-16 h-16 bg-surface-dark-lighter rounded-full flex items-center justify-center mb-4">
                <span class="material-icons-outlined text-3xl text-gray-600">search_off</span>
              </div>
              <h3 class="text-xl font-medium text-white">No notes found</h3>
              <p class="text-gray-500 mt-2 max-w-sm">We couldn't find any notes matching your filters. Try adjusting your search or Filters.</p>
              <a href="/explore" class="mt-6 text-primary hover:text-primary-hover font-medium hover:underline">Clear all filters</a>
            </div>
        <% } else { %>
    
          <div id="noteGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <% notes.forEach(note => { %>
              <div class="group bg-surface-dark border border-border-dark rounded-xl overflow-hidden hover:border-primary/50 transition-all duration-300 hover:shadow-xl hover:shadow-primary/5 flex flex-col h-full relative">
                
                <!-- Hover Glow -->
                <div class="absolute -inset-0.5 bg-primary/20 rounded-xl opacity-0 group-hover:opacity-100 blur transition duration-500 -z-10"></div>
    
                <!-- Card Header -->
                <div class="p-5 flex-1 start-card-content">
                  <div class="flex items-start justify-between mb-4">
                    <div class="h-10 w-10 rounded-lg bg-surface-dark-lighter border border-border-dark flex items-center justify-center text-primary">
                        <span class="material-icons-outlined">description</span>
                    </div>
                    <span class="text-xs font-medium px-2 py-1 rounded bg-surface-dark-lighter text-gray-400 border border-border-dark">
                        <%= note.subject?.name || 'General' %>
                    </span>
                  </div>
                  
                  <h3 class="text-lg font-semibold text-white mb-1 line-clamp-2 group-hover:text-primary transition-colors">
                    <%= note.title %>
                  </h3>
                  <p class="text-sm text-gray-500 mb-4"><%= note.course %></p>
                  
                  <!-- Uploader Info -->
                  <div class="flex items-center gap-2 mt-auto pt-4 border-t border-border-dark/50">
                    <div class="text-xs text-gray-400 flex items-center gap-1">
                        By <span class="text-gray-300 font-medium"><%= note.uploadedBy?.username || 'Unknown' %></span>
                        <% if (note.uploadedBy?.roles?.isModerator) { %>
                            <img src="/images/blueCheckmark.svg" class="w-3 h-3" title="Moderator">
                        <% } else if (note.uploadedBy?.roles?.isDev) { %>
                            <img src="/images/icons8-checkmark.svg" class="w-3 h-3" title="dev">
                        <% } else if (note.uploadedBy?.verification?.verified) { %>
                            <span class="text-accent-green text-[10px]" title="Verified">✔</span>
                        <% } %>
                    </div>
                  </div>
                </div>
    
                <!-- Card Footer (Stats) -->
                <div class="px-5 py-3 bg-black/20 border-t border-border-dark flex items-center justify-between text-xs text-gray-500">
                  <div class="flex items-center gap-3">
                    <span class="flex items-center gap-1">
                        <span class="material-icons-outlined text-[14px]">download</span>
                        <%= note.downloadCount %>
                    </span>
                     <span class="flex items-center gap-1">
                        <span class="material-icons-outlined text-[14px]">calendar_today</span>
                        <%= note.createdAt ? new Date(note.createdAt).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : '' %>
                    </span>
                  </div>
                  <a href="/notes/<%= note._id %>" class="text-white hover:text-primary transition-colors font-medium">View &rarr;</a>
                </div>
              </div>
            <% }) %>
          </div>
    
        <% } %>
    
        <div class="mt-12 text-center load-more-wrap">
          <% if (currentPage < totalPages) { %>
            <button id="loadMoreBtn" class="px-6 py-3 bg-surface-dark border border-border-dark text-white rounded-lg hover:bg-surface-dark-lighter hover:border-gray-600 transition-colors font-medium">
                Load More Notes
            </button>
          <% } %>
        </div>
      </main>
      
    </div>
    
    <script>
      (function() {
        // --- 1. SETUP & UTILS ---
        
        // Debounce Utility
        function debounce(func, wait) {
          let timeout;
          return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }
    
        // Elements
        const headerSearchInput = document.querySelector('#headerSearchForm input[name="q"]');
        const filterSearchInput = document.querySelector('#filterSearchInput'); // Hidden one
        const filterForm = document.getElementById('filterForm');
        const courseSelect = document.querySelector('select[name="course"]');
        const semesterSelect = document.querySelector('select[name="semester"]');
        const resetBtn = document.getElementById('resetBtn');
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const noteGrid = document.getElementById("noteGrid");
    
        // Sync Logic: Header Search -> Filter Input
        if(headerSearchInput && filterSearchInput) {
            headerSearchInput.addEventListener('input', (e) => {
                filterSearchInput.value = e.target.value;
                // Optional: Trigger search immediately or wait for enter?
                // Let's debounce trigger it
                debouncedSearch();
            });
        }
    
        // --- 2. EVENT LISTENERS ---
    
        // Reset
        resetBtn?.addEventListener('click', () => {
          window.location.href = "/explore";
        });
    
        // Filter Form Submit (Prevent default, use AJAX)
        filterForm?.addEventListener('submit', (e) => {
          e.preventDefault();
          appendNotes(true); 
        });
    
        // Auto-search (Debounced)
        const debouncedSearch = debounce(() => appendNotes(true), 500);
        
        // Select Changes
        courseSelect?.addEventListener('change', () => appendNotes(true));
        semesterSelect?.addEventListener('change', () => appendNotes(true));
    
        // Load More
        loadMoreBtn?.addEventListener("click", () => appendNotes(false));
    
    
        // --- 3. AJAX CORE ---
        let currentPage = <%= currentPage %>;
        let totalPages = <%= totalPages %>;
    
        async function appendNotes(reset = false) {
          if (reset) {
            currentPage = 0;
            // Show skeleton or loading state
            noteGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500 animate-pulse">Searching library...</div>';
            if(loadMoreBtn) loadMoreBtn.style.display = 'none';
          }
    
          currentPage++;
    
          // Build Params
          // Use filterSearchInput.value because that's our single source of truth for 'q' in this context
          const qVal = filterSearchInput ? filterSearchInput.value : '';
          
          const params = new URLSearchParams({
            q: qVal,
            course: courseSelect?.value || "",
            semester: semesterSelect?.value || "",
            page: currentPage
          });
    
          try {
            const res = await fetch("/explore?" + params.toString(), {
              headers: { "Accept": "application/json" }
            });
            const data = await res.json();
            
            if (reset) noteGrid.innerHTML = '';
    
            // Empty State
            if (data.notes.length === 0 && reset) {
              noteGrid.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-20 text-center border border-dashed border-border-dark rounded-xl bg-surface-dark/50">
                  <div class="w-16 h-16 bg-surface-dark-lighter rounded-full flex items-center justify-center mb-4">
                    <span class="material-icons-outlined text-3xl text-gray-600">search_off</span>
                  </div>
                  <h3 class="text-xl font-medium text-white">No notes found</h3>
                  <p class="text-gray-500 mt-2 max-w-sm">Try adjusting your search terms or filters.</p>
                </div>`;
              return;
            }
    
            // Render Cards
            data.notes.forEach(note => {
              const uploader = note.uploadedBy?.username || "Unknown";
              const dateStr = note.createdAt ? new Date(note.createdAt).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : '';
              
              let badge = "";
              if (note.uploadedBy?.roles?.isModerator) badge = `<img src="/images/blueCheckmark.svg" class="w-3 h-3" title="Moderator">`;
              else if (note.uploadedBy?.roles?.isDev) badge = `<img src="/images/icons8-checkmark.svg" class="w-3 h-3" title="dev">`;
              else if (note.uploadedBy?.verification?.verified) badge = `<span class="text-accent-green text-[10px]" title="Verified">✔</span>`;
    
              const html = `
               <div class="group bg-surface-dark border border-border-dark rounded-xl overflow-hidden hover:border-primary/50 transition-all duration-300 hover:shadow-xl hover:shadow-primary/5 flex flex-col h-full relative fade-in-up">
                  <!-- Hover Glow -->
                  <div class="absolute -inset-0.5 bg-primary/20 rounded-xl opacity-0 group-hover:opacity-100 blur transition duration-500 -z-10"></div>
    
                  <div class="p-5 flex-1">
                    <div class="flex items-start justify-between mb-4">
                      <div class="h-10 w-10 rounded-lg bg-surface-dark-lighter border border-border-dark flex items-center justify-center text-primary">
                          <span class="material-icons-outlined">description</span>
                      </div>
                      <span class="text-xs font-medium px-2 py-1 rounded bg-surface-dark-lighter text-gray-400 border border-border-dark">
                          ${note.subject?.name || 'General'}
                      </span>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-white mb-1 line-clamp-2 group-hover:text-primary transition-colors">
                      ${note.title}
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">${note.course}</p>
                    
                    <div class="flex items-center gap-2 mt-auto pt-4 border-t border-border-dark/50">
                      <div class="text-xs text-gray-400 flex items-center gap-1">
                          By <span class="text-gray-300 font-medium">${uploader}</span>
                          ${badge}
                      </div>
                    </div>
                  </div>
    
                  <div class="px-5 py-3 bg-black/20 border-t border-border-dark flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center gap-3">
                      <span class="flex items-center gap-1">
                          <span class="material-icons-outlined text-[14px]">download</span>
                          ${note.downloadCount}
                      </span>
                       <span class="flex items-center gap-1">
                          <span class="material-icons-outlined text-[14px]">calendar_today</span>
                          ${dateStr}
                      </span>
                    </div>
                    <a href="/notes/${note._id}" class="text-white hover:text-primary transition-colors font-medium">View &rarr;</a>
                  </div>
                </div>
              `;
              
              noteGrid.insertAdjacentHTML("beforeend", html);
            });
    
            // Update State
            totalPages = data.totalPages;
            
            if(loadMoreBtn) {
                if (currentPage >= totalPages) loadMoreBtn.style.display = 'none';
                else loadMoreBtn.style.display = 'block';
            }
    
          } catch (err) {
            console.error(err);
            if(reset) noteGrid.innerHTML = '<div class="col-span-full text-center text-red-400">Error loading notes. Please refresh.</div>';
          }
        }
      })();
    </script>