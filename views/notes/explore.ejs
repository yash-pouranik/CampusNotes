<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/css/explore.css">
<style>
  /* New SEO Description Style */
  .seo-desc {
    color: var(--muted);
    font-size: 1rem;
    max-width: 700px;
    margin: 8px 0 25px 0;
    line-height: 1.5;
  }
  @media (max-width: 768px) {
    .seo-desc { font-size: 0.9rem; margin-bottom: 20px; }
  }
</style>
</head>

  <header class="page-head">
    <div class="title-wrap">
      <h1>Explore SVVV Notes</h1>
      
      <p class="seo-desc">
        Welcome to the central library of <strong>CampusNotes</strong>. Browse verified handwritten notes, study materials, and assignments for 
        <strong>B.Tech (CSE, IT)</strong> students at SVVV. 
        Use the filters below to find content specific to your Course and Semester instantly.
      </p>
    </div>

    <div class="controls">
      <form id="headerSearchForm" class="search" method="GET" action="/explore">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/></svg>
        <input type="search" name="q" placeholder="Search topics..." value="<%= query || '' %>">
      </form>

      <a href="/most-downloaded" class="btn desktop-only">Most Downloaded</a>
    </div>
  </header>

  

  <form method="GET" action="/explore" class="top-filters" id="filterForm">
    <input type="text" id="filterSearchInput" name="q" placeholder="Filter results..." value="<%= query || '' %>">

    <select name="course">
      <option value="">All Courses</option>
      <% ["B.Tech CSE","B.Tech IT","MBA","BBA","MCA","BCA"].forEach(c => { %>
        <option value="<%= c %>" <%= course === c ? "selected" : "" %>><%= c %></option>
      <% }) %>
    </select>

    <select name="semester">
      <option value="">All Semesters</option>
      <% ["I","II","III","IV","V","VI","VII","VIII","IX","X"].forEach(s => { %>
        <option value="<%= s %>" <%= semester === s ? "selected" : "" %>><%= s %></option>
      <% }) %>
    </select>

    <button type="submit" class="btn">Apply</button>
    <button type="button" id="resetBtn" class="btn">Reset</button>
  </form>

  <% if (notes.length === 0) { %>
    <div style="text-align:center; padding:60px 20px; color:var(--muted);">
      <i class="fa-regular fa-folder-open" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
      <p>No notes found matching your criteria.</p>
      <a href="/explore" style="color:var(--accent); text-decoration:underline;">Clear Filters</a>
    </div>
  <% } else { %>

  <div class="note-grid" id="noteGrid">
    <% notes.forEach(note => { %>
      <article class="card">
        <div class="card-top">
          <div>
            <h3 class="title"><%= note.title %></h3>
            <div class="subtitle"><%= note.subject?.name || 'General' %> • <%= note.course %></div>
          </div>
        </div>

        <div class="card-body">
          <div style="display:flex; gap:8px;">
            <div class="tag"><i class="fa-solid fa-download"></i> &nbsp;<strong><%= note.downloadCount %></strong></div>
            <div class="tag"><strong><%= note.createdAt?.toDateString() %></strong></div>
          </div>
        </div>

        <div class="card-footer">
          <a class="view-btn" href="/notes/<%= note._id %>">View</a>
          <div class="badge">
            By <span style="color:var(--accent); margin-left:6px;"><%= note.uploadedBy?.username %></span>
            <% if (note.uploadedBy?.roles?.isModerator) { %>
              <img src="/images/blueCheckmark.svg" style="width:18px;margin-left:6px;" alt="Mod">
            <% } else if (note.uploadedBy?.roles?.isDev) { %>
              <img src="/images/icons8-checkmark.svg" style="width:18px;margin-left:6px;" alt="Dev">
            <% } else if (note.uploadedBy?.verification?.verified) { %>
              <span style="color:#56ff9a;margin-left:6px;">✔</span>
            <% } %>
          </div>
        </div>
      </article>
    <% }) %>
  </div>

  <% } %>

  <div class="load-more-wrap">
    <% if (currentPage < totalPages) { %>
      <button id="loadMoreBtn" class="load-more">Load more notes</button>
    <% } %>
  </div>

<script>
  (function() {
    // RESET FILTERS
    document.getElementById('resetBtn')?.addEventListener('click', () => {
      window.location.href = "/explore";
    });

    // DEBOUNCE FUNCTION
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    const filterInput = document.getElementById('filterSearchInput');
    const filterForm = document.getElementById('filterForm');
    
    // Prevent default submit
    filterForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      appendNotes(true); 
    });

    // Auto-search on typing
    filterInput?.addEventListener('input', debounce(() => {
      appendNotes(true);
    }, 500));

    // FILTER LISTENERS
    const courseSelect = document.querySelector('select[name="course"]');
    const semesterSelect = document.querySelector('select[name="semester"]');
    const applyBtn = document.querySelector('.top-filters button[type="submit"]');
    
    if(applyBtn) applyBtn.style.display = 'none'; // Hide apply button if JS is active

    courseSelect?.addEventListener('change', () => appendNotes(true));
    semesterSelect?.addEventListener('change', () => appendNotes(true));

    // LOAD MORE LOGIC
    let currentPage = <%= currentPage %>;
    let totalPages = <%= totalPages %>;
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const noteGrid = document.getElementById("noteGrid");

    async function appendNotes(reset = false) {
      if (reset) {
        currentPage = 0;
        noteGrid.innerHTML = '<div style="text-align:center;width:100%;padding:40px;color:var(--muted);">Loading...</div>';
      }

      currentPage++;

      const params = new URLSearchParams({
        q: filterInput?.value || "",
        course: courseSelect?.value || "",
        semester: semesterSelect?.value || "",
        page: currentPage
      });

      try {
        const res = await fetch("/explore?" + params.toString(), {
          headers: { "Accept": "application/json" }
        });
        const data = await res.json();
        
        if (reset) noteGrid.innerHTML = '';

        if (data.notes.length === 0 && reset) {
          noteGrid.innerHTML = `
            <div style="text-align:center; padding:60px 20px; color:var(--muted);">
              <i class="fa-regular fa-face-frown" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
              <p>No notes found matching your criteria.</p>
            </div>`;
          if(loadMoreBtn) loadMoreBtn.style.display = 'none';
          return;
        }

        data.notes.forEach(note => {
          const uploader = note.uploadedBy?.username || "Unknown";
          
          let badge = "";
          if (note.uploadedBy?.roles?.isModerator) badge = `<img src="/images/blueCheckmark.svg" style="width:18px;margin-left:6px;">`;
          else if (note.uploadedBy?.roles?.isDev) badge = `<img src="/images/icons8-checkmark.svg" style="width:18px;margin-left:6px;">`;
          else if (note.uploadedBy?.verification?.verified) badge = `<span style="color:#56ff9a;margin-left:6px;">✔</span>`;

          const html = `
            <article class="card">
              <div class="card-top">
                <div>
                  <h3 class="title">${note.title}</h3>
                  <div class="subtitle">${note.subject?.name || "General"} • ${note.course}</div>
                </div>
              </div>
              <div class="card-body">
                <div style="display:flex; gap:8px;">
                  <div class="tag"><i class="fa-solid fa-download"></i> &nbsp;<strong>${note.downloadCount}</strong></div>
                  <div class="tag"><strong>${new Date(note.createdAt).toDateString()}</strong></div>
                </div>
              </div>
              <div class="card-footer">
                <a class="view-btn" href="/notes/${note._id}">View</a>
                <div class="badge">
                  By <span style="color:var(--accent); margin-left:6px;">${uploader}</span>
                  ${badge}
                </div>
              </div>
            </article>
          `;
          noteGrid.insertAdjacentHTML("beforeend", html);
        });

        totalPages = data.totalPages;
        
        if(loadMoreBtn) {
            if (currentPage >= totalPages) loadMoreBtn.style.display = 'none';
            else loadMoreBtn.style.display = 'block';
        }

      } catch (err) {
        console.error(err);
        if(reset) noteGrid.innerHTML = '<div style="text-align:center;color:#ff6b6b;">Error loading notes. Please refresh.</div>';
      }
    }

    loadMoreBtn?.addEventListener("click", () => appendNotes(false));
  })();
</script>

<style>
    /* CSS for Ad Banner (Same as before) */
    .ad-banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, rgba(138, 47, 255, 0.15), rgba(0, 255, 213, 0.05));
      border: 1px solid rgba(138, 47, 255, 0.3);
      padding: 12px 20px;
      border-radius: 12px;
      margin-bottom: 22px;
      text-decoration: none;
      color: #e8f3ff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      backdrop-filter: blur(5px);
    }
    .ad-banner:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(138, 47, 255, 0.25);
      border-color: var(--accent-2);
    }
    .ad-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ad-badge {
      background: var(--accent-2);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .ad-text { font-size: 0.95rem; }
    @media (max-width: 600px) {
      .ad-content { flex-direction: column; gap: 6px; align-items: flex-start; }
    }
</style>